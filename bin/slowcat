#!/usr/bin/env python3

import sys
import time

from os.path import basename, exists


def print_stderr(*args, **kwargs):
    print(*args, file=sys.stderr, **kwargs)


def error(*args, **kwargs):
    print_stderr('[error]', *args, **kwargs)
    exit(1)


def usage(prog):
    prog = basename(prog)
    print_stderr('Usage:')
    print_stderr()
    print_stderr('Sponge mode:')
    print_stderr('$', prog, 'DELAY')
    print_stderr()
    print_stderr('Pipe mode:')
    print_stderr('$', 'seq 10', '|', prog, 'DELAY', '|', 'xargs', '...')
    exit(1)


def main(prog, argv):
    if '-h' in argv or '--help' in argv:
        usage(prog)

    delay = 1
    files = []

    while argv:
        if argv[0] in ('-d', '--delay'):
            argv.pop(0)
            try:
                if '.' in argv[0]:
                    delay = float(argv[0])
                else:
                    delay = int(argv[0])
            except ValueError:
                error('Delay must be an integer or a float number')

        elif argv[0] == '-':
            files.append(sys.stdin)

        elif argv[0].startswith('-'):
            error('Unknown option:', argv[0])

        else:
            if exists(argv[0]):
                files.append(argv[0])
            else:
                error('File not exists:', argv[0])

        argv.pop(0)

    if not files:
        files.append(sys.stdin)

    try:
        file = None
        for path in files:
            if path is sys.stdin:
                file = sys.stdin
            else:
                file = open(path, 'r', encoding='utf-8')

            for line in file:
                sys.stdout.write(line)
                sys.stdout.flush()
                time.sleep(delay)

            file.close()
    except:
        if file:
            file.close()
        sys.exit(1)


if __name__ == '__main__':
    try:
        main(sys.argv[0], sys.argv[1:])
    except KeyboardInterrupt:
        print_stderr('KeyboardInterrupt')

else:
    raise Exception('import no no')
